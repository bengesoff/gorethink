# Ensure the following environment variables are set
#  $WERCKER_SOURCE_DIR  = "$GOPATH/github.com/dancannon/gorethink"
#  $COVERALLS_TOKEN     = "..."

box: wercker/golang
# Services
services:
    - mies/rethinkdb@0.3.0
# Build definition
build:
    # The steps that will be executed on build
    steps:
        # Sets the go workspace and places you package
        # at the right place in the workspace tree
        - pjvds/setup-go-workspace

        - script:
            name: Populate cache
            code: |-
                if test -d "$WERCKER_CACHE_DIR/go-pkg-cache"; then rsync -avzv --exclude "$WERCKER_SOURCE_DIR" "$WERCKER_CACHE_DIR/go-pkg-cache/" "$GOPATH/" ; fi

        # Gets the dependencies
        - script:
            name: get dependencies
            code: |
                cd $WERCKER_SOURCE_DIR
                go version
                go get ./... && go get -u gopkg.in/check.v1 && go test -i
                go get github.com/pjvds/gocov/gocov
                go get github.com/mattn/goveralls

        # Build the project
        - script:
            name: build
            code: |
                go build ./...

        # Test the project
        - script:
            name: test
            code: |
                gocov test ./... > coverage.json

        - script:
            name: Coverage
            code: |-
                go get github.com/matm/gocov-html
                gocov report coverage.json
                gocov-html coverage.json > $WERCKER_REPORT_ARTIFACTS_DIR/coverage.html
        - script:
            name: Coveralls.io
            code: |-
                goveralls -package="./..." -service='wercker.com' $COVERALLS_TOKEN

        - script:
            name: Store cache
            code: |-
                rsync -avzv --exclude "$WERCKER_SOURCE_DIR" "$GOPATH/" "$WERCKER_CACHE_DIR/go-pkg-cache/"
